name: Auto Version Check and Bump on PR

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

jobs:
  version_check_and_bump:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the PR branch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0  # Ensures the full history is fetched for accurate diffing

      - name: Fetch develop branch
        run: git fetch origin develop:develop

      - name: Set up Git user
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version from develop
        id: get_develop_version
        run: |
          git checkout develop
          develop_version=$(jq -r .version package.json)
          echo "develop_version=$develop_version" >> $GITHUB_ENV
          echo "Current version on develop: $develop_version"

      - name: Ensure package.json has not been manually modified
        id: check_package_json_edit
        run: |
          # Check if package.json has been modified in this pull request
          if git diff --name-only origin/develop...HEAD | grep -q '^package.json$'; then
            echo "Error: package.json has been manually edited."
            exit 1
          fi

      - name: Check branch type and version bump label requirement
        id: check_branch_type_and_label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          branch_name="${{ github.head_ref }}"
          pr_labels=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name')

          # Check if branch requires a version bump label
          if [[ "$branch_name" =~ ^(release/|fix/|feat/|major/|hotfix/|test/|refactor/|style/) ]]; then
            if ! echo "$pr_labels" | grep -q -E 'version: major|version: minor|version: patch'; then
              echo "Error: Branch type '$branch_name' requires a version bump label (version: major, version: minor, or version: patch). Please add one of these labels."
              exit 1
            fi
          fi

      - name: Determine expected version based on label
        id: determine_version
        run: |
          current_version="${{ env.develop_version }}"
          branch_name="${{ github.head_ref }}"
          
          # Determine next expected version based on the label
          if echo "${{ github.event.pull_request.labels }}" | grep -q 'version: major'; then
            expected_version=$(echo "$current_version" | awk -F. '{print $1+1 ".0.0"}')
          elif echo "${{ github.event.pull_request.labels }}" | grep -q 'version: minor'; then
            expected_version=$(echo "$current_version" | awk -F. '{print $1 "." $2+1 ".0"}')
          elif echo "${{ github.event.pull_request.labels }}" | grep -q 'version: patch'; then
            expected_version=$(echo "$current_version" | awk -F. '{print $1 "." $2 "." $3+1}')
          else
            expected_version="$current_version"
          fi

          echo "expected_version=$expected_version" >> $GITHUB_ENV
          echo "Expected version based on label: $expected_version"

      - name: Update package.json if version does not match expected
        id: update_version
        run: |
          current_version=$(jq -r .version package.json)
          echo "Version in package.json: $current_version"
          
          if [ "$current_version" != "${{ env.expected_version }}" ]; then
            echo "Updating package.json to expected version ${{ env.expected_version }}"
            # Update version in package.json
            jq ".version = \"${{ env.expected_version }}\"" package.json > package.tmp && mv package.tmp package.json
          else
            echo "package.json version is already correct."
          fi

      - name: Commit and push version bump if updated
        if: steps.update_version.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add package.json
          git commit -m "chore: bump version to ${{ env.expected_version }} for PR"
          git push origin HEAD:${{ github.head_ref }} --force
