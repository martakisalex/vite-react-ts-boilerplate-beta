name: Auto Version Validation and Bump

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_target:
    types: [labeled, unlabeled]

jobs:
  validate-and-bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the PR branch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0  # Ensures the full history is fetched for accurate diffing

      - name: Fetch develop branch
        run: git fetch origin develop:develop

      - name: Set up Git user
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version from develop
        id: get_develop_version
        run: |
          git checkout develop
          develop_version=$(jq -r .version package.json)
          echo "develop_version=$develop_version" >> $GITHUB_ENV
          echo "Current version on develop: $develop_version"

      - name: Determine if branch name is valid
        id: validate_branch
        run: |
          branch_name="${{ github.head_ref }}"
          if [[ "$branch_name" =~ ^(feat|fix|hotfix|style|refactor|perf|test)/ ]]; then
            echo "Branch name is valid."
          else
            echo "Invalid branch name: $branch_name. Branch must start with one of feat/, fix/, hotfix/, style/, refactor/, perf/, or test/."
            exit 1
          fi

      - name: Verify PR label for version bump
        id: check_label
        run: |
          pr_number=${{ github.event.pull_request.number }}
          repo_full_name=${{ github.repository }}
          labels=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$repo_full_name/issues/$pr_number/labels")

          echo "Labels response: $labels"

          if echo "$labels" | jq empty; then
            label_names=$(echo "$labels" | jq -r '.[].name' | tr '\n' ' ')
            if [[ "$label_names" =~ "version: major" ]]; then
              bump_type="major"
            elif [[ "$label_names" =~ "version: minor" ]]; then
              bump_type="minor"
            elif [[ "$label_names" =~ "version: patch" ]]; then
              bump_type="patch"
            else
              echo "No valid version label found. Please add a label: version: major, version: minor, or version: patch."
              exit 1
            fi
            echo "bump_type=$bump_type" >> $GITHUB_ENV
          else
            echo "Failed to fetch labels or invalid JSON response."
            exit 1
          fi

      - name: Install dependencies
        run: npm install

      - name: Bump version with custom commit message
        if: ${{ env.bump_type != '' }}
        run: |
          git checkout ${{ github.head_ref }}
          old_version=$(jq -r .version package.json)
          npm version ${{ env.bump_type }} --no-git-tag-version
          new_version=$(jq -r .version package.json)
          git add package.json
          git commit -m "chore: bump version from $old_version to $new_version"

      - name: Push version bump commit
        if: ${{ env.bump_type != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin HEAD:${{ github.head_ref }}
